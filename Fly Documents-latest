<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="UTF-8">
<title>Documents - Edit your file</title>
<link rel="icon" href="Doc-icon.png" type="image/x-icon">
<style>
textarea { width: 100%; height: 400px; }
#editor {
    border: 2px dashed #ccc;
    padding: 10px;
}
</style>
</head>
<body>

<h2>ファイル編集＆名前変更保存ツール</h2>
<h3>Documents v2.x</h3>

<button id="openBtn">ファイルを開く</button>
<button id="newBtn">新規ファイル作成</button>
<button id="saveBtn" disabled>保存</button>
<button id="undoBtn" disabled>元に戻す</button>
<button id="redoBtn" disabled>やり直し</button>

<p>ファイル名: <input type="text" id="filename" placeholder="ファイル名を変更可能"></p>

<p>
編集モード: 
<select id="mode">
  <option value="text">テキストとして編集</option>
  <option value="base64">Base64編集（バイナリ用）</option>
</select>
</p>

<textarea id="editor" placeholder="ファイル内容がここに表示されます"></textarea>

<script>
// 変数の初期化
let fileHandle = null;
let originalFileName = "";
let historyStack = [];
let redoStack = [];
let isUndoRedoInProgress = false;
let autoSaveInterval = 60000;  // 1分ごとに自動保存（60,000ミリ秒）

// 自動保存を開始
function startAutoSave() {
    setInterval(async () => {
        await saveFile();  // 自動保存を非同期で実行
    }, autoSaveInterval);
}

// 自動保存処理
async function saveFile() {
    const filenameInput = document.getElementById("filename").value.trim();
    if (!filenameInput) {
        alert("ファイル名を入力してください");
        return;
    }

    const mode = document.getElementById("mode").value;
    let output;

    if (mode === "text") {
        output = new TextEncoder().encode(document.getElementById("editor").value);
    } else {
        try {
            output = new Uint8Array(base64ToArrayBuffer(document.getElementById("editor").value));
        } catch (e) {
            alert("Base64が正しくありません");
            return;
        }
    }

    try {
        if (filenameInput === originalFileName && fileHandle) {
            const writable = await fileHandle.createWritable();
            await writable.write(output);
            await writable.close();
            console.log(`自動保存完了: ${originalFileName}`);
        } else {
            const newHandle = await window.showSaveFilePicker({ suggestedName: filenameInput });
            const writableNew = await newHandle.createWritable();
            await writableNew.write(output);
            await writableNew.close();
            console.log(`自動保存完了: ${filenameInput}`);
        }
    } catch (err) {
        alert("保存に失敗しました");
        console.error(err);
    }
}

// Base64 エンコード
function arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary);
}

// Base64 デコード
function base64ToArrayBuffer(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
}

// 履歴の保存
function saveEditorState() {
    if (isUndoRedoInProgress) return;
    historyStack.push(document.getElementById("editor").value);
    redoStack = [];
    updateUndoRedoButtons();
}

// undoボタンの状態を更新
function updateUndoRedoButtons() {
    document.getElementById("undoBtn").disabled = historyStack.length === 0;
    document.getElementById("redoBtn").disabled = redoStack.length === 0;
}

// undo
document.getElementById("undoBtn").onclick = () => {
    if (historyStack.length > 0) {
        isUndoRedoInProgress = true;
        const previousState = historyStack.pop();
        redoStack.push(document.getElementById("editor").value);
        document.getElementById("editor").value = previousState;
        updateUndoRedoButtons();
        isUndoRedoInProgress = false;
    }
};

// redo
document.getElementById("redoBtn").onclick = () => {
    if (redoStack.length > 0) {
        isUndoRedoInProgress = true;
        const nextState = redoStack.pop();
        historyStack.push(document.getElementById("editor").value);
        document.getElementById("editor").value = nextState;
        updateUndoRedoButtons();
        isUndoRedoInProgress = false;
    }
};

// ファイルを開く処理（ドラッグ＆ドロップ以外）
document.getElementById("openBtn").onclick = async () => {
    try {
        [fileHandle] = await window.showOpenFilePicker();
        const file = await fileHandle.getFile();
        originalFileName = file.name;

        const mode = document.getElementById("mode").value;
        const buffer = await file.arrayBuffer();

        if (mode === "text") {
            try {
                document.getElementById("editor").value = new TextDecoder("utf-8", { fatal: false }).decode(buffer);
            } catch (err) {
                alert("テキストの読み込みに失敗しました");
                console.error(err);
            }
        } else {
            try {
                document.getElementById("editor").value = arrayBufferToBase64(buffer);
            } catch (err) {
                alert("Base64の読み込みに失敗しました");
                console.error(err);
            }
        }

        document.getElementById("filename").value = originalFileName;
        document.getElementById("saveBtn").disabled = false;
        historyStack = [];
        redoStack = [];
        updateUndoRedoButtons();
    } catch (err) {
        alert("ファイルの選択に失敗しました");
        console.error(err);
    }
};

// 新規ファイル作成
document.getElementById("newBtn").onclick = async () => {
    if (document.getElementById("editor").value !== "" && !confirm("変更が保存されていません。新しいファイルを作成しますか？")) {
        return;
    }

    const newFileName = prompt("新しいファイル名を入力してください（拡張子も含む）", "新しいファイル.txt");

};

// 保存（ファイル名変更有無で処理分岐）
document.getElementById("saveBtn").onclick = async () => {
    const filenameInput = document.getElementById("filename").value.trim();
    if (!filenameInput) {
        alert("ファイル名を入力してください");
        return;
    }

    const mode = document.getElementById("mode").value;
    let output;

    if (mode === "text") {
        output = new TextEncoder().encode(document.getElementById("editor").value);
    } else {
        try {
            output = new Uint8Array(base64ToArrayBuffer(document.getElementById("editor").value));
        } catch (e) {
            alert("Base64が正しくありません");
            return;
        }
    }

    try {
        if (filenameInput === originalFileName && fileHandle) {
            const writable = await fileHandle.createWritable();
            await writable.write(output);
            await writable.close();
            alert(`元のファイル "${originalFileName}" を上書き保存しました`);
        } else {
            const newHandle = await window.showSaveFilePicker({ suggestedName: filenameInput });
            const writableNew = await newHandle.createWritable();
            await writableNew.write(output);
            await writableNew.close();
            alert(`新しい名前で保存しました: ${filenameInput}`);
        }
    } catch (err) {
        alert("保存に失敗しました");
        console.error(err);
    }
};

// ドラッグアンドドロップでファイルを読み込む
document.getElementById("editor").addEventListener("dragover", (event) => {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
});

document.getElementById("editor").addEventListener("drop", async (event) => {
    event.preventDefault();
    const files = event.dataTransfer.files;
    if (files.length === 0) {
        alert("ファイルが選択されていません");
        return;
    }

    const file = files[0];
    const mode = document.getElementById("mode").value;
    const buffer = await file.arrayBuffer();

    if (mode === "text") {
        try {
            document.getElementById("editor").value = new TextDecoder("utf-8", { fatal: false }).decode(buffer);
        } catch (err) {
            alert("テキストの読み込みに失敗しました");
            console.error(err);
        }
    } else {
        try {
            document.getElementById("editor").value = arrayBufferToBase64(buffer);
        } catch (err) {
            alert("Base64の読み込みに失敗しました");
            console.error(err);
        }
    }

    document.getElementById("filename").value = file.name;
    historyStack = [];
    redoStack = [];
    updateUndoRedoButtons();
    document.getElementById("saveBtn").disabled = false;
});

// エディタ内容が変更されるたびに履歴を保存
document.getElementById("editor").addEventListener("input", () => {
    if (!isUndoRedoInProgress) {
        saveEditorState();
    }
});

// 自動保存を開始
startAutoSave();
</script>

</body>
</html>
